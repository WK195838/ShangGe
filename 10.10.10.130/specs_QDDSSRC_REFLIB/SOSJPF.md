# SOSJPF 檔案規格書

## 1. 基本資料
- **檔案名稱**: SOSJPF
- **檔案類型**: PF (實體檔案)
- **檔案說明**: 發票明細檔 - 銷貨發票明細管理檔案
- **建立日期**: (依系統記錄)
- **最後異動日期**: (依系統記錄)
- **參考檔案**: RERF (參考檔案)
- **特殊屬性**: *NOMAX (無最大記錄數限制)

## 2. 檔案功能說明
發票明細檔儲存發票中每個產品項目的詳細資訊，包含產品編號、數量、單價、金額等明細資料，是發票系統的核心明細管理檔案。

### 主要功能
- 發票明細資料管理
- 產品銷售明細記錄
- 數量價格明細計算
- 發票與產品關聯管理
- 銷售統計基礎資料
- 產品銷售分析支援

## 3. 系統檔案清單
| 檔案名稱 | 檔案類型 | 說明 |
|----------|----------|------|
| SOSJPF | PF | 發票明細檔 (實體檔案) |
| RERF | PF | 參考檔案 (欄位定義參考) |

## 4. 紀錄格式

### 4.1 實體檔案設定
```
REF(RERF)          // 參考檔案
UNIQUE             // 唯一鍵值設定
```

### 4.2 主要欄位規格
| 欄位代號 | 欄位名稱 | 型態 | 長度 | 小數 | 說明 |
|----------|----------|------|------|------|------|
| SJ01 | 客戶編號 | A | 10 | - | 客戶識別碼 |
| SJ02 | 發票號碼 | A | 10 | - | 發票識別號碼 |
| SJ03 | 產品編號 | A | 15 | - | 產品識別碼 |
| SJ04 | 數量 | N | 9 | 2 | 銷售數量 |
| SJ05 | 單價 | N | 9 | 2 | 產品單價 |
| SJ06 | 金額 | N | 11 | 2 | 小計金額 |
| SJ07 | 備註 | A | 30 | - | 明細備註 |

### 4.3 折扣與統計欄位
| 欄位代號 | 欄位名稱 | 型態 | 長度 | 小數 | 說明 |
|----------|----------|------|------|------|------|
| SJ08 | 折扣數量合計金額 | N | 11 | 2 | 折扣相關金額 |
| SJ09 | 折扣金額 | N | 9 | 2 | 折扣金額 |
| SJ10 | 產品稅則 | A | 10 | - | 產品稅則代號 |
| SJ11 | 轄區編號按發票 | A | 5 | - | 發票對應轄區 |
| SJ12 | 部門編號按發票 | A | 5 | - | 發票對應部門 |
| SJ13 | 庫存數量 | N | 9 | 2 | 庫存相關數量 |
| SJ14 | 折扣數量按數量 | N | 9 | 2 | 數量折扣 |
| SJ15 | 折扣數量按庫存 | N | 9 | 2 | 庫存折扣 |
| SJ16 | 發票日期 | N | 8 | 0 | 發票開立日期 |

### 4.4 擴充明細欄位
| 欄位代號 | 欄位名稱 | 型態 | 長度 | 小數 | 說明 |
|----------|----------|------|------|------|------|
| SJ071 | 備註2 | A | 30 | - | 額外備註 |
| SJ061 | 金額2 | N | 11 | 2 | 額外金額欄位 |
| SJ091 | 折扣金額2 | N | 9 | 2 | 額外折扣金額 |

### 4.5 系統欄位
| 欄位代號 | 欄位名稱 | 型態 | 長度 | 說明 |
|----------|----------|------|------|------|
| SJXX | 異動日期 | N | 8,0 | 記錄異動日期 |
| SJYY | 異動時間 | N | 6,0 | 記錄異動時間 |
| SJZZ | 異動人員 | A | 10 | 記錄異動人員 |

## 5. 主鍵欄位
- **主要鍵值**: SJ01 + SJ02 + SJ03
- **排序方式**: 客戶編號、發票號碼、產品編號升序
- **索引類型**: 複合主鍵，三層唯一性約束

## 6. 索引資料
- **主鍵**: SJ01 + SJ02 + SJ03 (客戶編號 + 發票號碼 + 產品編號)
- **唯一性**: UNIQUE 約束
- **參考完整性**: 與發票主檔、產品主檔關聯

## 7. 使用說明

### 7.1 檔案用途
- 發票明細資料集中管理
- 產品銷售明細記錄
- 發票金額明細計算
- 產品銷售統計基礎
- 庫存異動資料源
- 客戶購買行為分析

### 7.2 程式存取方式
```rpg
// 新增發票明細記錄
CHAIN (客戶編號:發票號碼:產品編號) SOSJPF;
IF NOT %FOUND(SOSJPF);
  CLEAR SJ0;
  SJ01 = 客戶編號;
  SJ02 = 發票號碼;
  SJ03 = 產品編號;
  SJ04 = 數量;
  SJ05 = 單價;
  SJ06 = 數量 * 單價;
  WRITE SJ0;
ENDIF;

// 查詢發票所有明細
SETLL (客戶編號:發票號碼) SOSJPF;
READ SOSJPF;
DOW NOT %EOF(SOSJPF) AND SJ01 = 客戶編號 AND SJ02 = 發票號碼;
  // 處理明細資料
  READ SOSJPF;
ENDDO;
```

### 7.3 明細計算邏輯
- **小計金額**: SJ06 = SJ04 × SJ05
- **折扣計算**: 依SJ09折扣金額調整
- **最終金額**: 小計金額 - 折扣金額

### 7.4 關聯檔案
- **發票主檔**: SJ01 + SJ02 關聯 SOSIPF
- **產品主檔**: SJ03 關聯產品資料
- **客戶主檔**: SJ01 關聯客戶資料

## 8. 備註
- 發票明細檔為發票系統核心明細檔案，資料完整性極為重要
- 支援*NOMAX設定，適應大量明細資料需求
- 提供完整的數量、金額、折扣計算欄位
- 包含轄區部門資訊，支援組織架構分析
- 系統欄位完整，支援異動追蹤與稽核需求 