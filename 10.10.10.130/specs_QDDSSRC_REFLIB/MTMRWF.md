# MTMRWF 檔案規格書

## 1. 基本資料

| 項目 | 內容 |
|------|------|
| 檔案名稱 | MTMRWF |
| 檔案描述 | 產品單位成本工作檔 |
| 檔案類型 | PF (Physical File) |
| 記錄格式 | MR0 |
| 主鍵 | MR01 + MR02 (產品代號 + 批次序號) |
| 檔案屬性 | 實體檔案，成本計算工作檔 |

## 2. 檔案功能說明

MTMRWF 為產品單位成本計算的工作檔案，提供：
- 產品單位成本計算處理
- 移動平均成本計算
- 成本批次處理作業
- 暫時成本資料儲存

## 3. 系統檔案清單

| 檔案代號 | 檔案名稱 | 說明 |
|----------|----------|------|
| MTMRWF | 產品單位成本工作檔 | 主檔 |
| MTMAPF | 產品基本資料實體檔 | 關聯檔案 |
| MTMHPF | 產品基本資料實體檔 KN | 關聯檔案 |
| RERF | 參考檔案 | 欄位定義參考 |

## 4. 紀錄格式

### 記錄格式：MR0

## 5. 欄位規格

| 欄位代號 | 欄位名稱 | 位置 | 長度 | 型態 | 屬性 | 檢核說明 |
|----------|----------|------|------|------|------|----------|
| MR01 | 產品代號 | 1-13 | 13 | A | R | 主鍵1，關聯MTMAPF.MA01 |
| MR02 | 批次序號 | 14-16 | 3 | N | R | 主鍵2，成本計算批次 |
| MR03 | 處理日期 | 17-24 | 8 | N | R | 成本計算處理日期 YYYYMMDD |
| MR04 | 處理時間 | 25-30 | 6 | N | R | 成本計算處理時間 HHMMSS |
| MR05 | 計算類型 | 31 | 1 | A | R | 'M'-移動平均，'W'-加權平均，'F'-先進先出 |
| MR06 | 處理狀態 | 32 | 1 | A | R | 'I'-初始，'P'-處理中，'C'-完成，'E'-錯誤 |
| MR07 | 期初數量 | 33-47 | 15 | N | R | 期初庫存數量 (13位整數，2位小數) |
| MR08 | 期初成本 | 48-62 | 15 | N | R | 期初單位成本 (11位整數，4位小數) |
| MR09 | 期初金額 | 63-77 | 15 | N | R | 期初庫存金額 (13位整數，2位小數) |
| MR10 | 入庫數量 | 78-92 | 15 | N | R | 本期入庫數量 (13位整數，2位小數) |
| MR11 | 入庫成本 | 93-107 | 15 | N | R | 本期入庫成本 (11位整數，4位小數) |
| MR12 | 入庫金額 | 108-122 | 15 | N | R | 本期入庫金額 (13位整數，2位小數) |
| MR13 | 出庫數量 | 123-137 | 15 | N | R | 本期出庫數量 (13位整數，2位小數) |
| MR14 | 出庫成本 | 138-152 | 15 | N | R | 本期出庫成本 (11位整數，4位小數) |
| MR15 | 出庫金額 | 153-167 | 15 | N | R | 本期出庫金額 (13位整數，2位小數) |
| MR16 | 期末數量 | 168-182 | 15 | N | R | 期末庫存數量 (13位整數，2位小數) |
| MR17 | 期末成本 | 183-197 | 15 | N | R | 期末單位成本 (11位整數，4位小數) |
| MR18 | 期末金額 | 198-212 | 15 | N | R | 期末庫存金額 (13位整數，2位小數) |
| MR19 | 調整數量 | 213-227 | 15 | N | R | 盤點調整數量 (13位整數，2位小數) |
| MR20 | 調整成本 | 228-242 | 15 | N | R | 調整單位成本 (11位整數，4位小數) |
| MR21 | 調整金額 | 243-257 | 15 | N | R | 調整金額 (13位整數，2位小數) |
| MR22 | 成本差異 | 258-272 | 15 | N | R | 成本差異金額 (13位整數，2位小數) |
| MR23 | 差異原因 | 273-277 | 5 | A | R | 差異原因代號 |
| MR24 | 計算基準日 | 278-285 | 8 | N | R | 成本計算基準日 YYYYMMDD |
| MR25 | 會計年月 | 286-291 | 6 | N | R | 會計年月 YYYYMM |
| MR26 | 幣別 | 292-294 | 3 | A | R | 成本計算幣別 |
| MR27 | 匯率 | 295-309 | 15 | N | R | 成本計算匯率 (8位整數，7位小數) |
| MR28 | 版本號 | 310-314 | 5 | A | R | 成本計算版本 |
| MR29 | 工廠代號 | 315-319 | 5 | A | R | 生產工廠代號 |
| MR30 | 倉庫代號 | 320-324 | 5 | A | R | 庫存倉庫代號 |
| MR31 | 成本中心 | 325-329 | 5 | A | R | 相關成本中心 |
| MR32 | 產品分類 | 330-334 | 5 | A | R | 產品分類代號 |
| MR33 | 品牌代號 | 335-339 | 5 | A | R | 產品品牌代號 |
| MR34 | 供應商 | 340-346 | 7 | A | R | 主要供應商代號 |
| MR35 | 採購單價 | 347-361 | 15 | N | R | 最新採購單價 (11位整數，4位小數) |
| MR36 | 標準成本 | 362-376 | 15 | N | R | 標準成本 (11位整數，4位小數) |
| MR37 | 實際成本 | 377-391 | 15 | N | R | 實際成本 (11位整數，4位小數) |
| MR38 | 計畫成本 | 392-406 | 15 | N | R | 計畫成本 (11位整數，4位小數) |
| MR39 | 重估成本 | 407-421 | 15 | N | R | 重估成本 (11位整數，4位小數) |
| MR40 | 材料成本 | 422-436 | 15 | N | R | 材料成本 (11位整數，4位小數) |
| MR41 | 人工成本 | 437-451 | 15 | N | R | 人工成本 (11位整數，4位小數) |
| MR42 | 製造費用 | 452-466 | 15 | N | R | 製造費用 (11位整數，4位小數) |
| MR43 | 直接成本 | 467-481 | 15 | N | R | 直接成本 (11位整數，4位小數) |
| MR44 | 間接成本 | 482-496 | 15 | N | R | 間接成本 (11位整數，4位小數) |
| MR45 | 運輸成本 | 497-511 | 15 | N | R | 運輸成本 (11位整數，4位小數) |
| MR46 | 關稅成本 | 512-526 | 15 | N | R | 關稅成本 (11位整數，4位小數) |
| MR47 | 其他成本 | 527-541 | 15 | N | R | 其他成本 (11位整數，4位小數) |
| MR48 | 計算方法 | 542-546 | 5 | A | R | 成本計算方法代號 |
| MR49 | 計算頻率 | 547 | 1 | A | R | 'D'-每日，'W'-每週，'M'-每月 |
| MR50 | 自動計算 | 548 | 1 | A | R | 'Y'-自動計算，'N'-手動計算 |
| MR51 | 確認狀態 | 549 | 1 | A | R | 'Y'-已確認，'N'-未確認 |
| MR52 | 確認日期 | 550-557 | 8 | N | R | 成本確認日期 YYYYMMDD |
| MR53 | 確認人員 | 558-567 | 10 | A | R | 成本確認人員 |
| MR54 | 備註說明 | 568-667 | 100 | A | R | 成本計算備註 |
| MR55 | 錯誤訊息 | 668-717 | 50 | A | R | 錯誤訊息說明 |
| MR56 | 重新計算 | 718 | 1 | A | R | 'Y'-需重算，'N'-無需重算 |
| MR57 | 凍結標記 | 719 | 1 | A | R | 'Y'-已凍結，'N'-未凍結 |
| MR58 | 歷史保留 | 720 | 1 | A | R | 'Y'-保留歷史，'N'-不保留 |
| MR59 | 備用欄位1 | 721-735 | 15 | A | R | 備用欄位1 |
| MR60 | 備用欄位2 | 736-750 | 15 | A | R | 備用欄位2 |
| MRXX | 建立日期 | 751-758 | 8 | N | R | 建立日期 YYYYMMDD |
| MRYY | 建立時間 | 759-764 | 6 | N | R | 建立時間 HHMMSS |
| MRZZ | 建立者 | 765-774 | 10 | A | R | 建立人員 |
| MR61 | 異動日期 | 775-782 | 8 | N | R | 最後異動日期 YYYYMMDD |
| MR62 | 異動時間 | 783-788 | 6 | N | R | 最後異動時間 HHMMSS |
| MR63 | 異動者 | 789-798 | 10 | A | R | 最後異動人員 |

## 6. 主鍵欄位

| 鍵值序號 | 欄位代號 | 欄位名稱 | 排序 |
|----------|----------|----------|------|
| 1 | MR01 | 產品代號 | 升序 |
| 2 | MR02 | 批次序號 | 升序 |

## 7. 索引資料

### 主要索引
- **索引名稱**：主鍵索引
- **索引欄位**：MR01 + MR02
- **索引類型**：PRIMARY
- **說明**：產品代號 + 批次序號複合升序排序

### 輔助索引
1. **處理日期索引**：MR03 + MR04 + MR01 + MR02 (處理日期 + 時間 + 產品 + 批次)
2. **處理狀態索引**：MR06 + MR03 + MR01 + MR02 (處理狀態 + 日期 + 產品 + 批次)
3. **計算類型索引**：MR05 + MR03 + MR01 + MR02 (計算類型 + 日期 + 產品 + 批次)
4. **會計年月索引**：MR25 + MR01 + MR02 (會計年月 + 產品 + 批次)
5. **工廠代號索引**：MR29 + MR01 + MR02 (工廠代號 + 產品 + 批次)
6. **倉庫代號索引**：MR30 + MR01 + MR02 (倉庫代號 + 產品 + 批次)
7. **成本中心索引**：MR31 + MR01 + MR02 (成本中心 + 產品 + 批次)
8. **產品分類索引**：MR32 + MR33 + MR01 + MR02 (產品分類 + 品牌 + 產品 + 批次)
9. **供應商索引**：MR34 + MR01 + MR02 (供應商 + 產品 + 批次)
10. **確認狀態索引**：MR51 + MR52 + MR01 + MR02 (確認狀態 + 確認日期 + 產品 + 批次)
11. **計算基準日索引**：MR24 + MR01 + MR02 (計算基準日 + 產品 + 批次)
12. **版本號索引**：MR28 + MR01 + MR02 (版本號 + 產品 + 批次)
13. **幣別索引**：MR26 + MR27 + MR01 + MR02 (幣別 + 匯率 + 產品 + 批次)
14. **凍結標記索引**：MR57 + MR01 + MR02 (凍結標記 + 產品 + 批次)
15. **異動日期索引**：MR61 + MR62 + MR01 + MR02 (異動日期 + 時間 + 產品 + 批次)

## 8. 備註

### 設計考量
1. 此檔案為產品單位成本計算的工作檔案
2. 支援多種成本計算方法和批次處理
3. 提供完整的成本組成分析

### 成本計算功能
- **移動平均成本**：支援移動平均成本計算
- **加權平均成本**：支援加權平均成本計算
- **先進先出成本**：支援FIFO成本計算
- **批次處理**：支援成本批次計算作業

### 成本組成分析
- **基本成本**：材料、人工、製造費用
- **分類成本**：直接成本、間接成本
- **附加成本**：運輸、關稅、其他成本
- **比較成本**：標準、實際、計畫、重估成本

### 處理狀態管理
- **I (初始)**：成本計算初始狀態
- **P (處理中)**：成本計算進行中
- **C (完成)**：成本計算已完成
- **E (錯誤)**：成本計算發生錯誤

### 計算類型支援
- **M (移動平均)**：移動平均成本法
- **W (加權平均)**：加權平均成本法
- **F (先進先出)**：先進先出成本法

### 會計期間管理
- **計算基準日**：成本計算的基準日期
- **會計年月**：相關會計期間
- **處理頻率**：每日、每週、每月計算

### 資料完整性控制
1. **主鍵唯一性**：MR01 + MR02 複合主鍵唯一
2. **外鍵檢查**：MR01 必須存在於 MTMAPF.MA01
3. **數量平衡**：期初+入庫-出庫+調整=期末
4. **金額平衡**：數量 × 單位成本 = 金額
5. **狀態一致性**：處理狀態與計算結果一致

### 業務規則
1. 產品代號必須存在於產品主檔中
2. 批次序號按時間順序自動編號
3. 成本計算必須符合會計原則
4. 確認後的成本不可隨意修改
5. 凍結的成本不可再計算

### 關聯檔案
- **產品主檔**：MTMAPF (MR01 = MA01)
- **產品主檔KN**：MTMHPF (MR01 = MH01)
- **供應商檔**：MTMBPF (MR34 = MB01)
- **工廠檔**：工廠檔 (MR29 = 工廠代號)
- **倉庫檔**：倉庫檔 (MR30 = 倉庫代號)
- **成本中心檔**：成本中心檔 (MR31 = 成本中心代號)

### 成本計算流程
1. **資料準備**：收集期初、入庫、出庫資料
2. **成本計算**：依計算方法計算單位成本
3. **金額計算**：計算各項成本金額
4. **差異分析**：分析成本差異原因
5. **結果確認**：成本計算結果確認
6. **資料更新**：更新產品主檔成本

### 批次處理機制
- **批次建立**：自動建立成本計算批次
- **批次處理**：批次執行成本計算
- **批次監控**：監控批次處理狀態
- **批次完成**：批次處理完成確認

### 多幣別支援
- **幣別管理**：支援多幣別成本計算
- **匯率處理**：自動取得計算日匯率
- **換算處理**：外幣成本換算本幣
- **匯差處理**：匯率差異處理

### 版本控制
- **版本管理**：成本計算版本管理
- **版本比較**：不同版本成本比較
- **版本確認**：成本版本確認機制
- **版本歷史**：保留歷史版本資料

### 使用場景
1. **定期成本計算**：月末成本計算作業
2. **即時成本查詢**：即時成本計算查詢
3. **成本分析**：成本組成分析
4. **差異分析**：成本差異原因分析

### 維護作業
- **批次建立**：建立成本計算批次
- **資料收集**：收集成本計算所需資料
- **成本計算**：執行成本計算作業
- **結果確認**：確認成本計算結果
- **資料清理**：清理過期工作資料

### 效能考量
1. **索引最佳化**：多個輔助索引提升查詢效能
2. **批次處理**：大量資料批次處理機制
3. **資料分割**：可考慮按月份分割資料
4. **平行處理**：支援多批次平行計算

### 安全控制
- **存取權限**：依職務控制存取權限
- **計算權限**：成本計算執行權限
- **確認權限**：成本確認授權機制
- **稽核記錄**：完整的成本計算稽核軌跡

### 資料品質
1. **資料完整性**：成本計算資料完整性檢查
2. **邏輯一致性**：成本計算邏輯一致性
3. **平衡檢查**：數量金額平衡檢查
4. **異常檢查**：成本異常值檢查
5. **差異分析**：成本差異合理性分析

### 報表支援
- **成本計算表**：成本計算明細表
- **差異分析表**：成本差異分析表
- **成本趨勢表**：成本變動趨勢表
- **批次處理報表**：批次處理狀況表

### 系統整合
- **ERP整合**：與ERP成本模組整合
- **會計整合**：與會計系統整合
- **庫存整合**：與庫存系統整合
- **採購整合**：與採購系統整合

### 使用注意事項
1. 此為工作檔案，計算完成後可清理
2. 重要成本資料建議備份後再計算
3. 批次處理期間避免異動基礎資料
4. 成本確認後需要授權才能修改
5. 定期檢查成本計算的合理性 